<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPGram - Web Client</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/telegram/browser/gramjs.js"></script>
    <style>
        :root {
            --tg-green: #2e7d32;
            --tg-light-green: #e8f5e9;
        }
        body { background-color: var(--tg-light-green); }
        .btn-green { background-color: var(--tg-green); color: white; }
        #log { font-family: monospace; font-size: 12px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="p-4 btn-green shadow-lg flex justify-between items-center">
        <h1 class="text-xl font-bold italic">IPGram</h1>
        <div id="status" class="text-sm">Ожидание настройки...</div>
    </header>

    <main class="flex-1 flex flex-col p-4 max-w-lg mx-auto w-full">
        <div id="auth-section" class="bg-white p-6 rounded-lg shadow-md space-y-4">
            <h2 class="text-lg font-semibold text-green-800">Вход в Telegram</h2>
            <input id="api-id" type="text" placeholder="API ID" class="w-full border p-2 rounded">
            <input id="api-hash" type="text" placeholder="API Hash" class="w-full border p-2 rounded">
            <input id="phone" type="text" placeholder="+79991234567" class="w-full border p-2 rounded">
            <button onclick="startAuth()" class="w-full btn-green py-2 rounded font-bold hover:bg-green-700 transition">
                Подключиться
            </button>
            
            <div id="code-section" class="hidden space-y-4">
                <hr>
                <input id="code" type="text" placeholder="Код из Telegram" class="w-full border p-2 rounded">
                <button onclick="submitCode()" class="w-full bg-orange-500 text-white py-2 rounded font-bold">
                    Войти
                </button>
            </div>
        </div>

        <div id="log" class="mt-4 p-2 bg-black text-green-400 rounded h-32 overflow-y-auto">
            > IPGram готов к работе...
        </div>
    </main>

    <script>
        const { TelegramClient } = window.gramjs;
        const { StringSession } = window.gramjs.sessions;
        
        let client;
        let apiId;
        let apiHash;
        let phoneNumber;

        const log = (msg) => {
            const el = document.getElementById('log');
            el.innerHTML += `<br>> ${msg}`;
            el.scrollTop = el.scrollHeight;
        };

        async function startAuth() {
            apiId = parseInt(document.getElementById('api-id').value);
            apiHash = document.getElementById('api-hash').value;
            phoneNumber = document.getElementById('phone').value;

            if (!apiId || !apiHash || !phoneNumber) {
                alert("Заполни все поля!");
                return;
            }

            const session = new StringSession("");
            client = new TelegramClient(session, apiId, apiHash, { connectionRetries: 5 });

            log("Запуск клиента...");
            await client.connect();
            
            document.getElementById('status').innerText = "Отправка кода...";
            
            await client.sendCode({ apiId, apiHash }, phoneNumber);
            document.getElementById('code-section').classList.remove('hidden');
            log("Код отправлен на ваш Telegram");
        }

        async function submitCode() {
            const code = document.getElementById('code').value;
            try {
                await client.signIn({
                    phoneNumber: phoneNumber,
                    phoneCode: async () => code,
                    onError: (err) => log("Ошибка: " + err.message),
                });
                
                log("Авторизация успешна!");
                document.getElementById('status').innerText = "В сети";
                document.getElementById('auth-section').innerHTML = 
                    "<h2 class='text-center text-green-600 font-bold'>Вы успешно вошли в IPGram!</h2>";
                
                // Здесь можно добавить загрузку списка чатов
                const me = await client.getMe();
                log("Добро пожаловать, " + me.firstName);
            } catch (e) {
                log("Ошибка: " + e.message);
            }
        }
    </script>
</body>
</html>
